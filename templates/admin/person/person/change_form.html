{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify %}

{% block after_related_objects %}
{{ block.super }}

{% if original and original.pk %}
<div class="module aligned">
    <h2>Existing Attachments</h2>
    {% if original.attachments.all %}
    <div class="attachments-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
        {% for attachment in original.attachments.all %}
        <div class="attachment-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
            <div class="attachment-header" style="margin-bottom: 10px;">
                <h4 style="margin: 0 0 5px 0; color: #333;">
                    {% if attachment.file %}
                    <a href="{{ attachment.file.url }}" target="_blank" style="color: #007cba; text-decoration: none;">
                        ğŸ“ {{ attachment.original_filename|default:attachment.file.name }}
                    </a>
                    {% else %}
                    ğŸ“ {{ attachment.original_filename|default:"No file" }}
                    {% endif %}
                </h4>
                <small style="color: #666;">Uploaded: {{ attachment.uploaded_at|date:"M d, Y H:i" }}</small>
            </div>
            
            {% if attachment.description %}
            <div class="attachment-description" style="margin-bottom: 8px;">
                <strong>Description:</strong> {{ attachment.description }}
            </div>
            {% endif %}
            
            {% if attachment.file_type %}
            <div class="attachment-type" style="margin-bottom: 8px;">
                <strong>Type:</strong> {{ attachment.file_type }}
            </div>
            {% endif %}

            {% if attachment.description and 'Auto-detected' in attachment.description %}
            <span class="source-badge" style="display: inline-block; padding: 2px 8px; background: #ffc107; color: #000; border-radius: 3px; font-size: 11px; margin-top: 5px;">
                ğŸ¤– Auto-detected
            </span>
            {% else %}
            <span class="source-badge" style="display: inline-block; padding: 2px 8px; background: #007cba; color: white; border-radius: 3px; font-size: 11px; margin-top: 5px;">
                ğŸ“¤ Uploaded
            </span>
            {% endif %}

            <div class="attachment-actions" style="margin-top: 10px;">
                {% if attachment.file %}
                <a href="{{ attachment.file.url }}" target="_blank" class="button" style="background: #007cba; color: white; padding: 5px 10px; text-decoration: none; border-radius: 3px; font-size: 12px; margin-right: 5px;">
                    Download
                </a>
                {% endif %}
                <a href="{% url 'admin:person_personattachment_change' attachment.id %}" class="button" style="background: #28a745; color: white; padding: 5px 10px; text-decoration: none; border-radius: 3px; font-size: 12px; margin-right: 5px;">
                    Edit
                </a>
                <a href="{% url 'admin:person_personattachment_delete' attachment.id %}?_popup=1" data-popup="yes" class="related-widget-wrapper-link button" style="background: #dc3545; color: white; padding: 5px 10px; text-decoration: none; border-radius: 3px; font-size: 12px;">
                    Delete
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-attachments" style="text-align: center; padding: 40px; color: #666; background: #f9f9f9; border-radius: 8px; margin-bottom: 30px;">
        <p style="font-size: 16px; margin: 0;">No attachments yet. Upload some files below!</p>
    </div>
    {% endif %}
</div>

<div class="folder-info" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #007cba; border-radius: 4px;">
    <h3 style="margin-top: 0;">ğŸ“ Media Folder</h3>
    <div style="display: flex; align-items: center; gap: 10px;">
        <code style="padding: 8px 12px; background: white; border: 1px solid #ddd; border-radius: 4px; flex: 1;">
            {{ original.get_attachment_folder_path }}
        </code>
        <button type="button"
                onclick="navigator.clipboard.writeText('{{ original.get_attachment_folder_path }}')"
                style="padding: 8px 16px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ğŸ“‹ Copy Path
        </button>
    </div>
    <p style="margin: 10px 0 0; color: #666; font-size: 13px;">
        Files placed in this folder will be automatically detected and added to this person. Subfolders are supported.
    </p>
</div>

<div class="sync-controls" style="margin: 20px 0;">
    <button type="button"
            onclick="syncAttachmentsNow()"
            style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
        ğŸ”„ Sync Folder Now
    </button>
    <span id="sync-status" style="margin-left: 15px; color: #666;"></span>
</div>

<div class="module aligned">
    <h2>Upload New Attachments</h2>
    <div class="description">
        <p>Drag and drop multiple files here or click to select files. You can add a description and file type for all uploaded files.</p>
    </div>
    <div class="form-row">
        <div class="field-box">
            <label for="id_new_attachments_files">Files:</label>
            <input type="file" name="new_attachments_files" id="id_new_attachments_files" multiple="multiple" 
                   style="min-height: 120px; border: 2px dashed #007cba; padding: 20px; text-align: center; background-color: #f9f9f9; cursor: pointer; width: 100%;">
        </div>
    </div>
    <div class="form-row">
        <div class="field-box">
            <label for="id_new_attachments_description">Description:</label>
            <textarea name="new_attachments_description" id="id_new_attachments_description" rows="3" cols="40" 
                      placeholder="Describe these attachments..."></textarea>
        </div>
    </div>
    <div class="form-row">
        <div class="field-box">
            <label for="id_new_attachments_file_type">File Type:</label>
            <input type="text" name="new_attachments_file_type" id="id_new_attachments_file_type" maxlength="50" 
                   placeholder="e.g., document, photo, certificate">
        </div>
    </div>
</div>
<script>
function syncAttachmentsNow() {
    const statusEl = document.getElementById('sync-status');
    if (!statusEl) {
        return;
    }

    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrfToken = csrfInput ? csrfInput.value : '';

    statusEl.textContent = 'Syncing...';
    statusEl.style.color = '#007cba';

    fetch(`/admin/person/person/{{ original.pk }}/sync/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
    })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            if (data.files_created > 0) {
                statusEl.textContent = `âœ“ Created ${data.files_created} new attachment(s)`;
                statusEl.style.color = '#28a745';
                setTimeout(() => window.location.reload(), 1500);
            } else {
                statusEl.textContent = `âœ“ All files already synced (${data.files_existing} file(s))`;
                statusEl.style.color = '#28a745';
            }
        })
        .catch(error => {
            console.error('Sync error:', error);
            statusEl.textContent = 'âœ— Sync failed';
            statusEl.style.color = '#dc3545';
        });
}
</script>
{% endif %}
{% endblock %}
